# K線週期問題修復總結 🔧

## 問題描述

用戶修改後仍然看到10秒K線，而不是預期的1秒K線。

---

## 問題原因

### 根本原因：初始化時的硬編碼覆蓋

**發生位置：** `MainView.java` 第 1979-1980 行（修改前）

```java
// 預設使用 10 秒 K 線
currentKlineMinutes = -10;  // ❌ 這會覆蓋類變量聲明時的 -1
```

### 為什麼會被覆蓋？

Java的初始化順序：

```
1. 類變量聲明 
   ↓
   private int currentKlineMinutes = -1;  ✅ 設置為 -1
   
2. 構造函數
   ↓
   public MainView() { ... }
   
3. createCharts() 方法被調用
   ↓
   currentKlineMinutes = -10;  ❌ 又被改成 -10
```

**結果：** 雖然類變量聲明時設置了 `-1`，但在 `createCharts()` 初始化圖表時又被重新設置為 `-10`。

---

## 解決方案

### 修復1：移除硬編碼覆蓋（最關鍵）

**位置：** `MainView.java` 第 1979-1983 行

**修改前：**
```java
// 預設使用 10 秒 K 線
currentKlineMinutes = -10;  // ❌ 覆蓋了類變量的 -1
ohlcSeries = minuteToSeries.get(currentKlineMinutes);
```

**修改後：**
```java
// 預設使用 1 秒 K 線（固定週期）
// currentKlineMinutes 已在類變量聲明時設置為 -1，不需要再次設置
ohlcSeries = minuteToSeries.get(currentKlineMinutes);
```

### 修復2：調整數據保留量

**位置：** `MainView.java` 第 1965-1968 行

**修改後：**
```java
// 根據週期設置不同的最大保留數量
// 1秒: 300根(5分鐘) | 10秒: 180根(30分鐘) | 30秒: 120根(1小時) | 60秒: 60根(1小時)
int maxItems = (s == 1) ? 300 : (s == 10) ? 180 : (s == 30) ? 120 : 60;
try { srs.setMaximumItemCount(maxItems); } catch (Exception ignore) {}
```

**原因：** 之前所有週期都是30根，對1秒K線來說太少（只有30秒歷史）。

---

## 驗證方法

### 方法1：觀察K線更新頻率 ⏱️

**測試步驟：**
1. 啟動程式
2. 觀察K線圖表
3. 數一數10秒內新增了幾根K線

**預期結果：**
- ✅ **1秒K線：** 10秒內應該看到約10根新K線
- ❌ **10秒K線：** 10秒內只會看到1根新K線

---

### 方法2：檢查自動跟隨模式的時間跨度 📊

**測試步驟：**
1. 確認工具欄顯示 `🎯 自動跟隨`（預設模式）
2. 觀察K線圖表顯示的K線數量（應該是30根）
3. 估算這30根K線代表的時間長度

**預期結果：**
- ✅ **1秒K線：** 30根 = 30秒歷史（約半分鐘）
- ❌ **10秒K線：** 30根 = 300秒歷史（約5分鐘）

**視覺對比：**

```
1秒K線（正確）：
┌─────────────────────────────────────┐
│  ┌┐ ┌┐ ┌┐ ┌┐ ┌┐ ┌┐ ┌┐ ┌┐ ┌┐ ┌┐  │  <- 30根K線
│  └┘ └┘ └┘ └┘ └┘ └┘ └┘ └┘ └┘ └┘  │
│  ←────────────────────────────▶   │
│  30秒前                   現在    │
└─────────────────────────────────────┘
K線非常密集，快速更新


10秒K線（錯誤）：
┌─────────────────────────────────────┐
│  ┌┐    ┌┐    ┌┐    ┌┐    ┌┐       │  <- 30根K線
│  └┘    └┘    └┘    └┘    └┘       │
│  ←────────────────────────────▶   │
│  5分鐘前                  現在     │
└─────────────────────────────────────┘
K線比較稀疏，更新較慢
```

---

### 方法3：查看代碼驗證 💻

**檢查項目：**

1. **類變量聲明**（第 218 行）
   ```java
   private int currentKlineMinutes = -1;  // ✅ 應該是 -1
   ```

2. **週期數組**（第 211 行）
   ```java
   private final int[] klineSeconds = new int[]{1, 10, 30, 60};  // ✅ 應包含 1
   ```

3. **createCharts 初始化**（第 1979-1980 行）
   ```java
   // 預設使用 1 秒 K 線（固定週期）
   // currentKlineMinutes 已在類變量聲明時設置為 -1，不需要再次設置
   // ✅ 不應該有 currentKlineMinutes = -10;
   ```

---

## 快速測試檢查表 ✅

執行以下測試，確認修復成功：

### 啟動檢查

- [ ] 程式正常啟動，無錯誤
- [ ] 工具欄沒有 `◀ 週期 ▶` 按鈕
- [ ] 工具欄有 `🎯 自動跟隨` 按鈕

### K線週期檢查

- [ ] 觀察10秒，應該看到約10根新K線（而非1根）
- [ ] 自動跟隨模式下，30根K線應該代表約30秒（而非5分鐘）
- [ ] K線更新非常快速（每秒一次）

### 視圖切換檢查

- [ ] 點擊 `🎯 自動跟隨`，切換到 `📊 顯示全部`
- [ ] 顯示全部模式下，應該看到更多K線（最多300根 = 5分鐘）
- [ ] 再次點擊，切換回 `🎯 自動跟隨`
- [ ] 自動跟隨模式下，只顯示最近30根（30秒）

### 功能正常檢查

- [ ] 成交量圖同步更新（每秒）
- [ ] 信號標記正常顯示
- [ ] 技術指標（MA、VWAP等）正常計算
- [ ] 可以使用滑鼠滾輪縮放圖表

---

## 如果還是10秒K線怎麼辦？ ⚠️

### 可能的原因

1. **未重新編譯**
   - 修改代碼後需要重新編譯
   - Java可能仍在使用舊的class文件

2. **快取問題**
   - IDE可能快取了舊的編譯結果
   - 需要清理並重新編譯

3. **多個實例運行**
   - 可能有舊版本的程式仍在運行
   - 需要完全關閉後重新啟動

### 解決步驟

#### 步驟1：清理並重新編譯

```bash
# 清理所有編譯文件
cd D:\自動掛單版src
del /S *.class

# 重新編譯
javac -encoding UTF-8 -cp "lib/*" StockMainAction/view/MainView.java
javac -encoding UTF-8 -cp "lib/*" StockMainAction/StockMarketSimulation.java
```

#### 步驟2：確認所有Java進程已關閉

```powershell
# 查看正在運行的Java進程
tasklist | findstr java

# 如果有，強制結束
taskkill /F /IM java.exe
```

#### 步驟3：重新運行

```bash
java -cp ".;lib/*" StockMainAction.StockMarketSimulation
```

#### 步驟4：驗證代碼

如果還是不行，請驗證以下文件內容：

**檢查1：** `MainView.java` 第 218 行
```bash
# 在PowerShell中執行
Get-Content "D:\自動掛單版src\StockMainAction\view\MainView.java" | Select-Object -Index 217
```

**應該顯示：**
```java
    private int currentKlineMinutes = -1;  // 固定為1秒K線
```

**檢查2：** `MainView.java` 第 1979-1980 行
```bash
Get-Content "D:\自動掛單版src\StockMainAction\view\MainView.java" | Select-Object -Index 1978,1979
```

**應該顯示：**
```java
        // 預設使用 1 秒 K 線（固定週期）
        // currentKlineMinutes 已在類變量聲明時設置為 -1，不需要再次設置
```

**不應該有：**
```java
        currentKlineMinutes = -10;  // ❌ 如果看到這行，說明修改未生效
```

---

## 修改文件列表 📄

| 文件 | 修改內容 | 狀態 |
|-----|---------|-----|
| `MainView.java` 第 218 行 | `currentKlineMinutes = -1` | ✅ 已修改 |
| `MainView.java` 第 211 行 | 添加 `1` 到 `klineSeconds` | ✅ 已修改 |
| `MainView.java` 第 551-552 行 | 移除週期切換UI | ✅ 已修改 |
| `MainView.java` 第 1965-1968 行 | 調整數據保留量 | ✅ 已修改 |
| `MainView.java` 第 1979-1980 行 | **移除硬編碼覆蓋** | ✅ **已修復（關鍵）** |

---

## 總結

### 問題
- 類變量設置了 `-1`（1秒）
- 但 `createCharts()` 中又設置了 `-10`（10秒）
- 導致實際運行時還是10秒K線

### 解決
- 移除 `createCharts()` 中的硬編碼 `-10`
- 直接使用類變量中已設置的 `-1`

### 結果
- ✅ K線週期固定為1秒
- ✅ 每秒更新一根K線
- ✅ 最高精度的市場數據

---

**修復狀態：** ✅ 完成  
**測試狀態：** ⏳ 待用戶驗證  
**文件版本：** 1.0  
**最後更新：** 2025-10-23

