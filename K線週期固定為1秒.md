# K線週期固定為1秒

## 📅 修改時間
2025-10-23

---

## 🎯 修改目的

為了簡化用戶操作並聚焦於核心功能，做出以下調整：
1. **移除週期切換UI** - 不再讓用戶手動切換K線週期
2. **固定K線週期為1秒** - 提供最高精度的K線數據
3. **保留K線視圖切換功能** - 自動跟隨/顯示全部功能仍然可用

---

## 🔧 關鍵修復

### ⚠️ 發現的問題

用戶回報修改後仍然顯示10秒K線，檢查後發現：

**問題根源：** `createCharts()` 方法中有硬編碼覆蓋

**位置：** `MainView.java` 第 1979-1980 行（修改前）

```java
// 預設使用 10 秒 K 線
currentKlineMinutes = -10;  // ❌ 這會覆蓋類變量聲明時的 -1
```

**影響：** 雖然在類變量聲明時設置了 `currentKlineMinutes = -1`，但在 `createCharts()` 初始化圖表時又被重新設置為 `-10`，導致實際運行時還是10秒K線。

**解決方案：** 移除這個硬編碼賦值，直接使用類變量中的值。

---

## 📝 修改內容

### 1. 移除週期切換UI

**位置：** `MainView.java` 第 551-552 行

**修改前：**
```java
bar.addSeparator();
// [UI] 限制式K線週期切換（只允許相鄰週期切換）
bar.add(new JLabel("K線週期:"));
JButton periodPrevBtn = new JButton("◀");
JButton periodNextBtn = new JButton("▶");
JLabel periodLabel = new JLabel(periodNames[currentPeriodIndex]);
// ... 一大堆按鈕邏輯 ...
bar.add(periodPrevBtn);
bar.add(periodLabel);
bar.add(periodNextBtn);
bar.addSeparator();
```

**修改後：**
```java
bar.addSeparator();
// [UI] K線週期已固定為1秒，週期切換UI已移除
```

**效果：**
- ✅ 工具欄不再顯示 `◀ 10秒 ▶` 按鈕
- ✅ 界面更簡潔
- ✅ 用戶不會誤操作切換週期

---

### 2. 固定K線週期為1秒

#### 2.1 修改預設週期

**位置：** `MainView.java` 第 218 行

**修改前：**
```java
private int currentKlineMinutes = -10;  // 預設10秒K線
```

**修改後：**
```java
private int currentKlineMinutes = -1;  // 固定為1秒K線
```

#### 2.2 更新週期鏈配置

**位置：** `MainView.java` 第 220-224 行

**修改前：**
```java
// [限制式週期切換] 週期切換鏈（只允許在相鄰週期間切換，確保倍數關係）
// 切換路徑：10秒 ↔ 30秒 ↔ 60秒(1分) ↔ 5分 ↔ 10分 ↔ 30分 ↔ 60分
private final int[] periodChain = new int[]{-10, -30, -60, 5, 10, 30, 60};
private final String[] periodNames = new String[]{"10秒", "30秒", "1分", "5分", "10分", "30分", "60分"};
private int currentPeriodIndex = 0;  // 預設在鏈中的位置（10秒）
```

**修改後：**
```java
// [限制式週期切換] 週期切換鏈（已停用，保留代碼以防未來需要）
// 注意：週期已固定為1秒，不再支持切換
private final int[] periodChain = new int[]{-1, -10, -30, -60, 5, 10, 30, 60};
private final String[] periodNames = new String[]{"1秒", "10秒", "30秒", "1分", "5分", "10分", "30分", "60分"};
private int currentPeriodIndex = 0;  // 固定在1秒（索引0）
```

**說明：**
- ✅ 將1秒（-1）加入週期鏈的第一個位置
- ✅ 保留週期切換代碼結構，方便未來可能的需求變更
- ✅ `currentPeriodIndex = 0` 固定指向1秒

#### 2.3 添加1秒支持到秒級數組

**位置：** `MainView.java` 第 209-211 行

**修改前：**
```java
// K線多週期管理（新增 10秒、30秒 以秒為單位以 0.x 表示，內部會換算）
private final int[] klineMinutes = new int[]{1, 5, 10, 30, 60};
private final int[] klineSeconds = new int[]{10, 30, 60};
```

**修改後：**
```java
// K線多週期管理（支持1秒到60分鐘）
private final int[] klineMinutes = new int[]{1, 5, 10, 30, 60};
private final int[] klineSeconds = new int[]{1, 10, 30, 60};  // 新增1秒週期
```

**說明：**
- ✅ `klineSeconds` 數組新增 `1`
- ✅ 確保1秒週期的OHLC數據結構能正確初始化
- ✅ 確保1秒週期的成交量數據結構能正確初始化

---

#### 2.4 🔧 修復初始化時的硬編碼覆蓋（關鍵修復）

**位置：** `MainView.java` 第 1979-1983 行

**修改前：**
```java
}
// 預設使用 10 秒 K 線
currentKlineMinutes = -10;  // ❌ 這會覆蓋類變量聲明時的 -1
ohlcSeries = minuteToSeries.get(currentKlineMinutes);
OHLCSeriesCollection ohlcCollection = minuteToCollection.get(currentKlineMinutes);
candleChart = ChartFactory.createCandlestickChart("K線走勢", "時間", "價格", ohlcCollection, true);
```

**修改後：**
```java
}
// 預設使用 1 秒 K 線（固定週期）
// currentKlineMinutes 已在類變量聲明時設置為 -1，不需要再次設置
ohlcSeries = minuteToSeries.get(currentKlineMinutes);
OHLCSeriesCollection ohlcCollection = minuteToCollection.get(currentKlineMinutes);
candleChart = ChartFactory.createCandlestickChart("K線走勢", "時間", "價格", ohlcCollection, true);
```

**說明：**
- ❌ **問題：** `createCharts()` 中的硬編碼 `-10` 會覆蓋類變量的 `-1`
- ✅ **修復：** 移除硬編碼賦值，直接使用類變量中已設置的值
- ✅ **原因：** Java初始化順序是：類變量聲明 → 構造函數 → `createCharts()`
- ✅ **結果：** 確保實際運行時使用1秒K線

---

#### 2.5 調整1秒K線的數據保留量

**位置：** `MainView.java` 第 1963-1972 行

**修改前：**
```java
for (int s : klineSeconds) {
    OHLCSeries srs = new OHLCSeries("K線(" + s + "秒)");
    try { srs.setMaximumItemCount(30); } catch (Exception ignore) {}
    minuteToSeries.put(-s, srs);
    OHLCSeriesCollection c = new OHLCSeriesCollection();
    c.addSeries(srs);
    minuteToCollection.put(-s, c);
}
```

**修改後：**
```java
for (int s : klineSeconds) {
    OHLCSeries srs = new OHLCSeries("K線(" + s + "秒)");
    // 根據週期設置不同的最大保留數量
    // 1秒: 300根(5分鐘) | 10秒: 180根(30分鐘) | 30秒: 120根(1小時) | 60秒: 60根(1小時)
    int maxItems = (s == 1) ? 300 : (s == 10) ? 180 : (s == 30) ? 120 : 60;
    try { srs.setMaximumItemCount(maxItems); } catch (Exception ignore) {}
    minuteToSeries.put(-s, srs);
    OHLCSeriesCollection c = new OHLCSeriesCollection();
    c.addSeries(srs);
    minuteToCollection.put(-s, c);
}
```

**說明：**
- ✅ **1秒K線：** 保留300根 = 5分鐘歷史
- ✅ **10秒K線：** 保留180根 = 30分鐘歷史
- ✅ **30秒K線：** 保留120根 = 1小時歷史
- ✅ **60秒K線：** 保留60根 = 1小時歷史
- ✅ **原因：** 週期越小，需要更多根數來保存相同時長的歷史

---

### 3. 保留K線視圖切換功能

**位置：** `MainView.java` 第 554-572 行

**保持不變：**
```java
// [K線自動跟隨] 自動跟隨/顯示全部 切換按鈕
bar.add(new JLabel("K線視圖:"));
JButton followBtn = new JButton(autoFollowLatest ? "🎯 自動跟隨" : "📊 顯示全部");
followBtn.setToolTipText(autoFollowLatest ? 
    "當前自動跟隨最近30根K線，點擊切換到顯示全部" : 
    "當前顯示全部K線，點擊切換到自動跟隨");

followBtn.addActionListener(e -> {
    autoFollowLatest = !autoFollowLatest;
    // ... 切換邏輯 ...
});
bar.add(followBtn);
```

**效果：**
- ✅ K線視圖切換按鈕保留在工具欄
- ✅ 用戶仍然可以在「自動跟隨」和「顯示全部」之間切換
- ✅ 這是用戶真正需要的核心功能

---

## 🎯 修改後的工具欄

### 修改前

```
┌────────────────────────────────────────────────────────────────┐
│ ... │ K線週期: ◀ 10秒 ▶ │ K線視圖: 🎯 自動跟隨 │ 指標設定 │
└────────────────────────────────────────────────────────────────┘
```

### 修改後

```
┌────────────────────────────────────────────────────┐
│ ... │ K線視圖: 🎯 自動跟隨 │ 指標設定 │
└────────────────────────────────────────────────────┘
```

**改進：**
- ✅ 界面更簡潔
- ✅ 減少用戶困惑
- ✅ 聚焦於核心功能

---

## 📊 1秒K線特性

### 優勢

1. **最高精度** ⚡
   - 每秒一根K線
   - 捕捉最細微的價格變動
   - 適合高頻交易分析

2. **數據量適中** 📈
   - 30根K線 = 30秒歷史
   - 300根K線 = 5分鐘歷史
   - 在自動跟隨模式下視覺效果良好

3. **技術指標靈敏** 🎯
   - MA、VWAP等指標反應迅速
   - 信號標記更精確
   - 適合短線操作

### 注意事項

1. **數據更新頻率高** ⚠️
   - 每秒更新一次
   - 確保系統效能足夠
   - 建議使用自動跟隨模式（默認只顯示30根）

2. **歷史數據量大** 💾
   - 1小時 = 3,600根K線
   - 建議設置合理的 `maxItemCount` 限制
   - 當前設置：每個週期最多保留300根

3. **視覺密度** 👀
   - 1秒K線非常密集
   - 自動跟隨模式（30根）最佳：顯示最近30秒
   - 顯示全部模式下可能需要縮放查看

---

## 🔧 如果未來需要恢復週期切換

### 恢復步驟

1. **恢復UI代碼**
   - 在工具欄重新添加週期切換按鈕
   - 參考 Git 歷史記錄中的原始代碼

2. **調整預設週期**
   - 如果不想以1秒為預設，修改 `currentPeriodIndex`
   - 例如：`currentPeriodIndex = 1;` 改為10秒（索引1）

3. **調整週期鏈**
   - 修改 `periodChain` 和 `periodNames` 數組
   - 添加或移除支持的週期

### 代碼位置

所有週期相關的功能都保留完整：
- ✅ `switchToPeriod()` 方法（第 2918 行）
- ✅ `aggregatePeriodData()` 方法
- ✅ `resetDomainAxisForPeriod()` 方法
- ✅ `realignSignalMarkers()` 方法

只需要重新添加UI按鈕即可。

---

## ✅ K線視圖功能驗證

### 功能1：自動跟隨模式（預設）

**操作：**
1. 啟動程式（預設為自動跟隨模式）
2. 觀察K線圖

**預期效果：**
- ✅ 顯示最近30根K線（最近30秒）
- ✅ 新K線出現時自動向左滾動
- ✅ 始終保持最新數據在視圖右側
- ✅ 視圖穩定，不會跳動

**驗證方式：**
```
工具欄顯示：K線視圖: 🎯 自動跟隨

K線圖表現：
┌─────────────────────────────────────┐
│  ┌┐ ┌┐   ┌┐  ┌┐ ┌┐              │
│  └┘ └┘ ┌┐└┘  └┘ └┘              │
│        └┘                        │
│  ←─────────────────────────────▶ │
│  30秒前              現在         │
└─────────────────────────────────────┘
只顯示最近30根（30秒），自動滾動
```

---

### 功能2：顯示全部模式

**操作：**
1. 點擊工具欄的 `🎯 自動跟隨` 按鈕
2. 按鈕變為 `📊 顯示全部`
3. 觀察K線圖

**預期效果：**
- ✅ 顯示所有累積的K線（最多300根 = 5分鐘）
- ✅ 可以使用滑鼠滾輪縮放
- ✅ 可以拖動查看不同時間段
- ✅ 域軸自動調整以顯示全部數據

**驗證方式：**
```
工具欄顯示：K線視圖: 📊 顯示全部

K線圖表現：
┌─────────────────────────────────────┐
│┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐    │
│└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘    │
│  ←─────────────────────────────▶   │
│  最早                     最新      │
└─────────────────────────────────────┘
顯示所有K線，可縮放和拖動
```

**訊息區日誌：**
```
已切換到顯示全部模式
```

---

### 功能3：模式切換

**操作：**
1. 在顯示全部模式下，點擊 `📊 顯示全部` 按鈕
2. 切換回自動跟隨模式

**預期效果：**
- ✅ 按鈕文字變回 `🎯 自動跟隨`
- ✅ 圖表立即調整為顯示最近30根
- ✅ 域軸範圍自動調整

**訊息區日誌：**
```
已切換到自動跟隨模式
```

---

## 📝 測試清單

### 基本功能測試

- [ ] 啟動程式，確認預設為1秒K線
  - 方法1：觀察K線更新頻率（每秒一根）
  - 方法2：檢查訊息區日誌，看是否有K線相關的時間戳
  - 方法3：觀察自動跟隨模式下30根K線 = 30秒歷史
- [ ] 確認工具欄沒有週期切換按鈕（`◀ 10秒 ▶`）
- [ ] 確認工具欄有K線視圖切換按鈕（`🎯 自動跟隨` 或 `📊 顯示全部`）
- [ ] 觀察K線是否每秒更新一次（10秒內應該看到10根新K線）

### 自動跟隨模式測試

- [ ] 預設模式下顯示約30根K線（30秒）
- [ ] 新K線出現時自動向左滾動
- [ ] 視圖穩定，不會跳動
- [ ] Y軸範圍自動調整（價格軸）

### 顯示全部模式測試

- [ ] 點擊按鈕切換到顯示全部
- [ ] 顯示所有累積的K線
- [ ] 可以使用滑鼠滾輪縮放
- [ ] 可以拖動查看歷史數據
- [ ] 再次點擊切換回自動跟隨

### 性能測試

- [ ] CPU使用率正常（1秒更新不會過載）
- [ ] 記憶體使用穩定（不會持續增長）
- [ ] 圖表繪製流暢（60 FPS）
- [ ] 訊息區日誌正常輸出

### 成交量測試

- [ ] 成交量圖同步顯示1秒數據
- [ ] 成交量柱顏色正確（紅漲綠跌）
- [ ] 成交量MA5/MA10正確計算
- [ ] 成交量與K線時間對齊

### 信號標記測試

- [ ] 多頭/空頭信號正確顯示
- [ ] 大買單/大賣單正確標記
- [ ] 買賣盤失衡信號正確標記
- [ ] 標記點位置對齊K線

---

## 🎉 總結

### 修改概要

✅ **移除週期切換UI**
- 簡化界面
- 避免用戶混淆
- 聚焦核心功能

✅ **固定為1秒K線**
- 最高精度
- 適合高頻分析
- 技術指標靈敏

✅ **保留視圖切換**
- 自動跟隨模式（實時監控）
- 顯示全部模式（歷史分析）
- 功能完整可用

### 未來擴展性

- ✅ 週期切換代碼完整保留
- ✅ 如需恢復，只需添加UI按鈕
- ✅ 數據結構支持多週期
- ✅ 可快速切換回多週期模式

### 用戶體驗

- ✅ 界面簡潔清晰
- ✅ 功能聚焦明確
- ✅ 操作簡單直觀
- ✅ 效能優良穩定

---

**文件版本：** 1.0  
**最後更新：** 2025-10-23  
**修改狀態：** ✅ 完成，待測試驗證

